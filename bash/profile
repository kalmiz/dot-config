function pidof {
	COMMAND=$1
	PID=`ps -A -o pid,command | grep -e $COMMAND | grep -v grep | awk '{print $1}'`
	if [ -n "$PID" ]; then
		echo "$PID"
	fi
}

function vpn_password {
	security 2>&1 >/dev/null find-generic-password -ga "Gawker VPN" \
	| ruby -e 'print $1 if STDIN.gets =~ /^password: "(.*)"$/'
}

#
# Add these lines to `/etc/sudoers`:
#
# %admin  ALL=(ALL) NOPASSWD: /usr/local/bin/openconnect
# %admin  ALL=(ALL) NOPASSWD: /usr/bin/killall -SIGINT openconnect
#
VPN_USER=kalmi

function vpn_password {
  security 2>&1 >/dev/null find-generic-password -ga kinja-vpn \
  | ruby -e 'print $1 if STDIN.gets =~ /^password: "(.*)"$/'
}

function vpn {
  OPENCONNECT=$(pidof openconnect)
  echo "User: $VPN_USER"
  case "$1" in
    start)
      if [ -z "$OPENCONNECT" ] ; then
        echo "Connecting to VPN ..."
        echo $(vpn_password) | sudo openconnect --background -u $VPN_USER \
          --passwd-on-stdin vpn.kinja-ops.com
      fi
      ;;
    stop)
      if [ -n "$OPENCONNECT" ] ; then
        echo "Closing VPN connection ..."
        sudo killall -SIGINT openconnect
      fi
      ;;
    restart)
      vpn stop
      vpn start
      ;;
    status)
      if [ -n "$OPENCONNECT" ] ; then
        echo "VPN is connected"
      else
        echo "VPN is disconnected"
      fi
      ;;
    *)
      echo "Usage: vpn {start|stop|restart}"
      return 1
  esac
}

if [ -f ~/.bashrc ]; then
	source ~/.bashrc
fi
if [ -f ~/.config/git/git-completion.bash ]; then
	source ~/.config/git/git-completion.bash
fi

complete -C aws_completer aws

eval "$(scmpuff init -s)"

# OPAM configuration
. /Users/kalmi/.opam/opam-init/init.sh > /dev/null 2> /dev/null || true

