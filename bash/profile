function pidof {
	COMMAND=$1
	PID=`ps -A -o pid,command | grep -e $COMMAND | grep -v grep | awk '{print $1}'`
	if [ -n "$PID" ]; then
		echo "$PID"
	fi
}

function vpn_password {
	security 2>&1 >/dev/null find-generic-password -ga "Gawker VPN" \
	| ruby -e 'print $1 if STDIN.gets =~ /^password: "(.*)"$/'
}

#
# Add these lines to `/etc/sudoers`:
#
# %admin  ALL=(ALL) NOPASSWD: /usr/local/bin/openconnect
# %admin  ALL=(ALL) NOPASSWD: /usr/bin/killall -SIGINT openconnect
#
VPN_USER=$USER

shopt -s extglob
function vpn {
	case "$1" in
	dc)
		local VPN=${VPN_HOST:-"vpn.kinja-ops.com"}
		vpn_handler $2
		;;
	@(gcp|bfc|xyz) )
		local VPN="vpn-$1.kinja-ops.com"
		vpn_handler $2
		;;
	 @(start|status) )
		vpn dc $1
		[ "$1" = "start" ] && sleep 20
		vpn gcp $1
		;;
	stop)
		# stop in reserve order
		vpn gcp $1
		sleep 5
		vpn dc $1
		;;
	*)
		vpn_handler help
	esac
}

function vpn_handler {
	local HOST=${VPN:-"vpn.kinja-ops.com"}
	local OPENCONNECT=$(pidof "openconnect.*${HOST}")
	local USERNAME=${VPN_USER}
	local LOCALUSER=$(whoami)

	case "$1" in
	start)
		if [ -z "$OPENCONNECT" ] ; then
		echo "== Starting VPN"
		echo $(vpn_password) | sudo openconnect --script=/Users/${LOCALUSER}/bin/vpnc-script --background -u ${USERNAME} --passwd-on-stdin ${HOST}
		echo "Done"
		fi
		;;
	stop)
		if [ -n "$OPENCONNECT" ] ; then
		echo "== Stopping VPN"
		sudo kill -SIGINT ${OPENCONNECT}
		echo "Done"
		fi
		;;
	restart)
		vpn stop
		vpn start
		;;
	status)
		if [ "x$OPENCONNECT" == "x" ]; then
		echo "$HOST VPN is not running."
		return 1
		else
		echo "$HOST VPN is running. PID: $OPENCONNECT"
		fi
		;;
	help)
		echo "Usage: vpn [dc|gcp|xyz|bfc] {start|stop|status|restart}"
		return 1
	esac
}

if [ -f ~/.bashrc ]; then
	source ~/.bashrc
fi
if [ -f ~/.config/git/git-completion.bash ]; then
	source ~/.config/git/git-completion.bash
fi

complete -C aws_completer aws

eval "$(scmpuff init -s)"

init_rbenv () {
	eval "$(rbenv init -)"
}
